version: "3.8"

services:
  # LocalStack for local AWS services (DynamoDB, S3, etc.)
  localstack:
    profiles: ["full"]
    image: localstack/localstack:latest
    container_name: pathlab-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=dynamodb,s3,sqs,sns
      - DEBUG=0
      - DATA_DIR=/tmp/localstack/data
    volumes:
      - "./localstack-data:/tmp/localstack"
    networks:
      - pathlab
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # AI Referral Service
  ai-referral-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: pathlab-assist/pla-ai-referral-service:latest
    container_name: pathlab-ai-referral-service
    ports:
      - "8011:8080"
    environment:
      # Service
      - SERVICE_NAME=ai-referral-service
      - SERVICE_VERSION=1.0.0
      - ENVIRONMENT=development
      - SERVER_PORT=8080

      # AWS/LocalStack Configuration
      - AWS_ENDPOINT=http://pathlab-localstack:4566
      - AWS_REGION=us-east-1
      - AWS_LOCAL_MODE=true
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test

      # Authentication (using pathlab-assist-auth service)
      - JWT_ENABLED=true
      - JWT_JWKS_URL=http://pathlab-assist-auth:8080/.well-known/jwks.json
      - JWT_ISSUER=pathlab-assist-auth
      - OPA_ENABLED=false

      # Anthropic
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=claude-sonnet-4-5-20250929
      - MAX_IMAGE_SIZE_MB=10
      - SCAN_TIMEOUT_SECONDS=120

      # External Services
      - TEST_CATALOG_SERVICE_URL=http://pathlab-test-catalog-service:8080

      # OAuth Client Credentials (for service-to-service auth)
      - OAUTH_ENABLED=true
      - OAUTH_TOKEN_URL=http://pathlab-assist-auth:8080/v1/oauth/token
      - OAUTH_CLIENT_ID=ai-referral-service
      - OAUTH_CLIENT_SECRET=ai-referral-secret
      - OAUTH_SCOPES=system:catalog:read system/Test.read

      # Logging
      - LOG_LEVEL=DEBUG
      - LOG_OUTPUT_JSON=false

      # CORS
      - CORS_ENABLED=true
      - CORS_ALLOWED_ORIGINS=*

      # Audit Configuration
      - AUDIT_ENABLED=false
    networks:
      - pathlab
    # Don't use depends_on because LocalStack might be started by another service
    # Instead, the application should handle connection retries

networks:
  pathlab:
    name: pathlab
    external: true
